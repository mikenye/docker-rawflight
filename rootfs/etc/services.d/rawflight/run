#!/usr/bin/with-contenv bash
# shellcheck shell=bash

# First socat take beast data and sends to standard output
# pv (pipe viewer) shows stats about the transfer every 900 seconds
# Second socat reads from standard input and sends to rawflight

set -o pipefail

echo "Feeding data from $BEASTHOST:$BEASTPORT to $RAWFLIGHTHOST:$RAWFLIGHTPORT"

{ socat -d -u TCP:"$BEASTHOST":"$BEASTPORT" - | \
  { pv -t -r -b -f -N statistics -c --interval 300 | \
    socat -d -u - TCP:"$RAWFLIGHTHOST":"$RAWFLIGHTPORT"; }; \
  } \
 2>&1 | stdbuf -oL tr '\r' '\n' | \
 stdbuf -o0 awk '{print "[rawflight] " strftime("%Y/%m/%d %H:%M:%S", systime()) " " $0}'
 
echo "Disconnected"

sleep 3
